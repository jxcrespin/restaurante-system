<!DOCTYPE html>
<html>
<head>
  <title>Mesero - Pedidos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .table-btn {
      font-size: 1.1rem;
      padding: 12px;
    }
    .selected {
      background-color: #0d6efd !important;
      color: white;
    }
    .occupied {
      background-color: #6c757d !important;
      color: white;
    }
  </style>
</head>
<body class="p-3">

<h3>üë®‚Äçüíº Mesero - Nuevo Pedido</h3>

<h5>Mesas</h5>
<div id="tables" class="row g-2 mb-3"></div>

<h5>Productos</h5>
<div id="products" class="row g-2 mb-3"></div>

<h5>Pedido actual</h5>
<ul id="orderList" class="list-group mb-3"></ul>

<div class="d-flex gap-2">
  <button class="btn btn-success" onclick="sendOrder()">Enviar pedido</button>
  <button class="btn btn-danger" onclick="cancelOrder()">Cancelar pedido</button>
</div>

<script>
let selectedTable = null;
let orderItems = {};

async function loadTables() {
  const res = await fetch("/tables/status");
  const tables = await res.json();
  const div = document.getElementById("tables");
  div.innerHTML = "";

  tables.forEach(t => {
    const col = document.createElement("div");
    col.className = "col-6 col-md-2";

    const btn = document.createElement("button");
    btn.className = "btn w-100 table-btn";

    if (t.status === "OCCUPIED") {
      btn.classList.add("occupied");
      btn.disabled = true;
    } else {
      btn.classList.add("btn-outline-primary");
      btn.onclick = () => selectTable(t.id, btn);
    }

    btn.innerText = "Mesa " + t.number;
    col.appendChild(btn);
    div.appendChild(col);
  });
}

function selectTable(id, btn) {
  document.querySelectorAll(".table-btn").forEach(b => b.classList.remove("selected"));
  btn.classList.add("selected");
  selectedTable = id;
}

async function loadProducts() {
  const res = await fetch("/products");
  const products = await res.json();
  const div = document.getElementById("products");
  div.innerHTML = "";

  products.forEach(p => {
    const col = document.createElement("div");
    col.className = "col-6 col-md-3";

    const btn = document.createElement("button");
    btn.className = "btn btn-outline-secondary w-100";
    btn.innerText = p.name;
    btn.onclick = () => addProduct(p.id, p.name);

    col.appendChild(btn);
    div.appendChild(col);
  });
}

function addProduct(id, name) {
  if (!orderItems[id]) orderItems[id] = { name, quantity: 0 };
  orderItems[id].quantity++;
  renderOrder();
}

function renderOrder() {
  const list = document.getElementById("orderList");
  list.innerHTML = "";

  Object.entries(orderItems).forEach(([id, item]) => {
    const li = document.createElement("li");
    li.className = "list-group-item d-flex justify-content-between align-items-center";
    li.innerHTML = `
      ${item.name} x${item.quantity}
      <div>
        <button class="btn btn-sm btn-outline-danger" onclick="removeProduct(${id})">-</button>
      </div>
    `;
    list.appendChild(li);
  });
}

function removeProduct(id) {
  orderItems[id].quantity--;
  if (orderItems[id].quantity <= 0) delete orderItems[id];
  renderOrder();
}

function cancelOrder() {
  orderItems = {};
  selectedTable = null;
  renderOrder();
  document.querySelectorAll(".table-btn").forEach(b => b.classList.remove("selected"));
}

async function sendOrder() {
  if (!selectedTable) {
    alert("Seleccione una mesa");
    return;
  }

  const items = Object.entries(orderItems).map(([id, item]) => ({
    product_id: parseInt(id),
    quantity: item.quantity
  }));

  if (items.length === 0) {
    alert("Agregue productos");
    return;
  }

  const res = await fetch("/orders", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({
      table_id: selectedTable,
      items: items
    })
  });

  const data = await res.json();

  if (data.success) {
    alert("Pedido enviado");
    cancelOrder();
    loadTables();
  }
}

loadTables();
loadProducts();
</script>

</body>
</html>

